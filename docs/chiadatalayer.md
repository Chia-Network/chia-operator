# ChiaDataLayer

* [Mnemonic Secret](#secret-key)
* [Certificate Authority](#certificate-authority)
* [Trusted Peers](#trusted-peers)
* [Storage for Server Files](#server-file-storage)
* [Filter out XCH Spam](#filter-out-xch-spam)
* [Fileserver Configuration](#fileserver-configuration)
  * [Common Fileserver Configurations](#common-fileserver-configurations)
  * [Environment Variables](#additional-environment-variables)
  * [Healthchecks](#container-health-checks)
  * [Resource Limits/Requests](#resource-requirements)
  * [Security Contexts](#security-context)
  * [Ingress](#ingress-configuration)
* [More info](#more-info)

Specifying a ChiaDataLayer will create a Kubernetes Deployment and Services for a Chia DataLayer server that connects to a local [full_node](chianode.md). It also requires a specified [Chia certificate authority](chiaca.md).

It is also expected you have a pre-existing Chia key to import, likely one that you generated locally in a Chia GUI installation.

Here's a minimal ChiaDataLayer example custom resource (CR):

```yaml
apiVersion: k8s.chia.net/v1
kind: ChiaDataLayer
metadata:
  name: my-datalayer
spec:
  chia:
    # A local full_node using kubernetes DNS names
    fullNodePeers:
      - host: "node.default.svc.cluster.local"
        port: 8444
    # A kubernetes Secret named chiakey-secret containing a key.txt file with your mnemonic key
    secretKey:
      name: "chiakey-secret"
      key: "key.txt"
```

## Secret key

The `secretKey` field in the ChiaDataLayer's spec defines the name of a Kubernetes Secret that contains your mnemonic. Only Wallets and Farmers need your mnemonic key to function. You can create your Kubernetes Secret like so:

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: chiakey-secret
stringData:
  key.txt: "your mnemonic goes here"
type: Opaque
```

Replace the text value for `key.txt` with your mnemonic, and then reference it in your ChiaDataLayer resource in the way shown above.

## Certificate Authority

If you have your own Certificate Authority to pass to initialize chia from:

```yaml
spec:
  chia:
    caSecretName: chiaca-secret
```

[See the chiaca documentation](chiaca.md#manually-create-a-ca-secret) for information on creating a certificate authority Secret for chia.

## Trusted Peers

You can specify trusted CIDRs for your DataLayer server using the `trustedCIDRs` field:

```yaml
spec:
  chia:
    trustedCIDRs:
      - "192.168.1.0/24"
      - "10.0.0.0/8"
```

## Filter out XCH Spam

By default, Chia protects your wallet against "dust storms," see [What is the dust filter?](https://docs.chia.net/faq/?_highlight=dust&_highlight=storm#what-is-the-dust-filter) in Chia's documentation. If you have a reason to set something other than the default filter, you can set the xch_spam_amount field like so:

```yaml
spec:
  chia:
    xchSpamAmount: 1000000
```

This field defaults to `1000000` if unspecified. Any 64bit unsigned integer (0-18446744073709551615) will fit in this field.

## Server File Storage

With chia-operator, data_layer server files (the .dat files) are located in a volume mounted to the `/datalayer/server` directory in the chia container. See the [Fileserver Configuration](#fileserver-configuration) section for how to serve these files to the public.

By default, this directory will be an emptyDir volume, which doesn't persist on Pod restarts. Most of the time you will want to define a persistent volume or hostpath for persistence. Within the yaml for a ChiaDatalayer deployment, you can have a persistent volume generated for your server files:

```yaml
spec:
  storage:
    dataLayerServerFiles:
      persistentVolumeClaim:
        generateVolumeClaims: true
        storageClass: "standard"
        resourceRequest: "10Gi"
        # Optional: if unspecified accessModes will just be set to ReadWriteOnce
        accessModes:
          - "ReadWriteOnce"
```

Or, if you would rather mount an externally managed persistent volume (one not generated by chia-operator), you can do that by specifying the name of the PersistentVolumeClaim that you've already created:

```yaml
spec:
  storage:
    dataLayerServerFiles:
      persistentVolumeClaim:
        claimName: "my-server-files"
```

Or, if you would like to mount a hostPath to store your data_layer server files:

```yaml
spec:
  storage:
    dataLayerServerFiles:
      hostPathVolume:
        path: "/path/on/the/kubernetes/node"
```

If you use a hostPath volume in a kubernetes cluster with multiple nodes, make sure you have set the proper nodeSelector to ensure the data_layer Pod only runs on the node with that hostPath.

In all three cases, the volume will be automatically mounted in the chia container at `/datalayer/server`.

See the [Storage](storage.md) documentation for information on CHIA_ROOT persistence, which is separate from the server files volume.

## Fileserver Configuration

The ChiaDataLayer can optionally run a fileserver sidecar container to serve the data_layer server files. This will be needed if you plan to mirror data or publish your own data on DataLayer. This is disabled by default but can be enabled with these fileserver configuration options:

```yaml
spec:
  fileserver:
    enabled: true
    # Optional: defaults to the official chia image using data_layer_http,
    # but a custom image for the fileserver can be specified here.
    image: "custom/fileserver:tag"
    # Optional: custom mount path for server files (.dat files)
    # This is the mount path in the fileserver container only.
    # It will not change the mount path in the chia container.
    # This path is what webserver software would set the webroot to
    serverFileMountpath: "/custom/path"
    # Optional: custom fileserver container port. This port defaults
    # to 8575 (the data_layer_http default port) and should be changed
    # when using a webserver (like nginx) that binds to a different port
    containerPort: 8080
    # Optional: service configuration. Most people will not need
    # to change this, see the Services and Networking doc linked below
    # to see available options
    service:
      enabled: true
      type: ClusterIP
```

References for service endpoint configuration fields can be found in the [kubernetes docs](https://kubernetes.io/docs/concepts/services-networking/service/#publishing-services-service-types) and for the [Chia operator specifically](https://github.com/Chia-Network/chia-operator/blob/main/docs/services-networking.md). The .dat files will be available at a service endpoint on port 80.

NOTE: Besides running a fileserver alongside the ChiaDataLayer deployment as a sidecar, you may also optionally wish to manage your own highly available webserver deployments external to chia-operator. To do so, just ensure the ChiaDataLayer builtin fileserver is disabled, and deploy your web server application of choice while mounting the server files volume. If doing a highly available fileserver deployment, you may want to ensure that the server files volume uses a `ReadWriteMany` access mode. See the [kubernetes documentation on Persistent Volumes](https://kubernetes.io/docs/concepts/storage/persistent-volumes/) to find the correct PVC configuration for your intended web server setup.

### Common Fileserver Configurations

These examples are intended to be copied exactly and provide working configurations.  The `metadata` may need to be updated for your configuration, but the other fields are unlikely to need to change for most applications.

#### Default data_layer_http

```yaml
apiVersion: k8s.chia.net/v1
kind: ChiaDataLayer
metadata:
  name: my-datalayer
spec:
  chia:
    caSecretName: "chiaca-secret"
    secretKey:
      name: "chiakey-secret"
      key: "key.txt"
  fileserver:
    enabled: true
```

#### nginx

```yaml
apiVersion: k8s.chia.net/v1
kind: ChiaDataLayer
metadata:
  name: my-datalayer
spec:
  chia:
    caSecretName: "chiaca-secret"
    secretKey:
      name: "chiakey-secret"
      key: "key.txt"
  fileserver:
    enabled: true
    image: nginx:latest
    serverFileMountpath: /usr/share/nginx/html # defines the mount path for the server files volume in the container. This root where Nginx will serve files from and should be set as shown here unless using a custom Nginx container
    containerPort: 80 # defines the port of the http server in the container
```

### Additional Environment Variables

You can add custom environment variables to the fileserver container using the `additionalEnv` field:

```yaml
spec:
  fileserver:
    enabled: true
    additionalEnv:
      - name: CUSTOM_VAR
        value: "custom-value"
      - name: SECRET_VAR
        valueFrom:
          secretKeyRef:
            name: my-secret
            key: secret-key
```

### Container Health Checks

The fileserver container supports standard Kubernetes probes for health checking:

```yaml
spec:
  fileserver:
    enabled: true
    # Liveness probe to check if container is running properly
    livenessProbe:
      httpGet:
        path: /health
        port: 8080
      initialDelaySeconds: 30
      periodSeconds: 10
    # Readiness probe to check if container is ready to accept traffic
    readinessProbe:
      httpGet:
        path: /ready
        port: 8080
      initialDelaySeconds: 5
      periodSeconds: 5
    # Startup probe to give container time to initialize
    startupProbe:
      httpGet:
        path: /startup
        port: 8080
      failureThreshold: 30
      periodSeconds: 10
```

### Resource Requirements

You can specify resource limits and requests for the fileserver container:

```yaml
spec:
  fileserver:
    enabled: true
    resources:
      requests:
        memory: "256Mi"
        cpu: "250m"
      limits:
        memory: "512Mi"
        cpu: "500m"
```

### Security Context

You can configure the security context for the fileserver container:

```yaml
spec:
  fileserver:
    enabled: true
    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL
```

### Ingress Configuration

You can configure an Ingress resource for the fileserver:

```yaml
spec:
  fileserver:
    enabled: true
    ingress:
      enabled: true
      ingressClassName: nginx
      host: datalayer.example.com
      # Add custom labels and annotations to the Ingress
      labels:
        environment: production
      annotations:
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
        nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
        nginx.ingress.kubernetes.io/proxy-body-size: "50m"
      tls:
        - hosts:
            - datalayer.example.com
          secretName: datalayer-tls
```

## More Info

This page contains documentation specific to this resource. Please see the rest of the documentation for information on more available configurations.

* [Generic options for all chia-operator resources.](all.md)
* [chia-exporter configuration](chia-exporter.md)
* [Services and networking](services-networking.md)
* [Storage](storage.md)
